<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Board</title>
    <style>
        :root {
            --primary-color: #0055A5; --secondary-color: #f4f7f9; --text-color: #333;
            --border-color: #e0e0e0; --bg-color: #fff; --shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        body { font-family: sans-serif; margin: 0; background-color: var(--secondary-color); color: var(--text-color); }
        header { background-color: var(--bg-color); padding: 15px 30px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        main { padding: 20px; }
        .hidden { display: none; }

        /* Login Screen */
        #login-screen { text-align: center; max-width: 400px; margin: 50px auto; padding: 30px; background: var(--bg-color); border-radius: 8px; box-shadow: var(--shadow); }
        #login-screen select, #login-screen button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); }

        /* Board Screen */
        #board-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #board-header h1 { margin: 0; }
        .controls button { padding: 8px 12px; border: none; background-color: var(--primary-color); color: white; border-radius: 4px; cursor: pointer; }
        .board-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; }
        .column { background: var(--secondary-color); border-radius: 8px; padding: 15px; min-width: 300px; }
        .column h2 { margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
        .task-list { min-height: 50px; }
        .task { background: var(--bg-color); border-radius: 4px; padding: 15px; margin-bottom: 10px; box-shadow: var(--shadow); cursor: pointer; }
        .task h3 { margin: 0 0 5px 0; font-size: 1em; }
        .task p { margin: 0; font-size: 0.9em; color: #666; }
        .task .assignee { font-size: 0.8em; font-style: italic; margin-top: 10px; }
        .task-actions { margin-top: 10px; }
        .task-actions button { font-size: 0.8em; padding: 4px 8px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">Project Board</div>
        <div id="user-info"></div>
    </header>

    <main>
        <!-- Login Screen -->
        <section id="login-screen">
            <h2>Выберите пользователя</h2>
            <select id="user-select">
                <option value="user-1">Admin User</option>
                <option value="user-2">Regular User</option>
            </select>
            <button id="login-btn">Войти</button>
        </section>

        <!-- Board Screen -->
        <section id="board-screen" class="hidden">
            <div id="board-header">
                <h1 id="board-name"></h1>
                <div class="controls">
                    <button id="analytics-btn" class="hidden">Показать аналитику</button>
                    <button id="create-task-btn" class="hidden">Создать задачу</button>
                </div>
            </div>
            <div class="board-container" id="board-container">
                <!-- Columns and tasks will be rendered here by JavaScript -->
            </div>
        </section>

        <!-- Analytics Screen -->
        <section id="analytics-screen" class="hidden" style="margin-top: 20px; padding: 20px; background: #fff; border-radius: 8px;">
            <h2>Аналитика доски</h2>
            <div id="analytics-content"></div>
            <button id="back-to-board-btn">Назад к доске</button>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                currentUser: null,
                currentBoard: null,
                users: {
                    'user-1': { name: 'Admin User' },
                    'user-2': { name: 'Regular User' }
                }
            };

            // DOM Elements
            const loginScreen = document.getElementById('login-screen');
            const boardScreen = document.getElementById('board-screen');
            const userSelect = document.getElementById('user-select');
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const boardNameEl = document.getElementById('board-name');
            const boardContainer = document.getElementById('board-container');
            const createTaskBtn = document.getElementById('create-task-btn');
            const analyticsBtn = document.getElementById('analytics-btn');
            const analyticsScreen = document.getElementById('analytics-screen');
            const analyticsContent = document.getElementById('analytics-content');
            const backToBoardBtn = document.getElementById('back-to-board-btn');


            // --- AUTHENTICATION ---
            loginBtn.addEventListener('click', () => {
                const userId = userSelect.value;
                if (userId) {
                    state.currentUser = { id: userId, name: state.users[userId].name };
                    localStorage.setItem('currentUserId', userId);
                    userInfo.textContent = `Вы вошли как: ${state.currentUser.name}`;
                    loginScreen.classList.add('hidden');
                    boardScreen.classList.remove('hidden');
                    loadBoard('board-1'); // Hardcoded boardId for now
                }
            });

            function checkLogin() {
                const userId = localStorage.getItem('currentUserId');
                if (userId && state.users[userId]) {
                     // Trigger login flow
                    userSelect.value = userId;
                    loginBtn.click();
                }
            }

            // --- BOARD RENDERING ---
            async function loadBoard(boardId) {
                if (!state.currentUser) return;
                try {
                    const response = await fetch(`/.netlify/functions/get-board?boardId=${boardId}&userId=${state.currentUser.id}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load board: ${response.statusText}`);
                    }
                    const boardData = await response.json();
                    state.currentBoard = boardData;
                    renderBoard();
                } catch (error) {
                    console.error(error);
                    alert(error.message);
                }
            }

            function renderBoard() {
                if (!state.currentBoard) return;

                boardNameEl.textContent = state.currentBoard.name;
                boardContainer.innerHTML = ''; // Clear existing content

                // Show admin controls if user is an admin
                if (state.currentBoard.userRole === 'Board Admin') {
                    createTaskBtn.classList.remove('hidden');
                    analyticsBtn.classList.remove('hidden');
                } else {
                    createTaskBtn.classList.add('hidden');
                    analyticsBtn.classList.add('hidden');
                }

                // Render columns
                state.currentBoard.columns.sort((a, b) => a.order - b.order).forEach(column => {
                    const columnEl = document.createElement('div');
                    columnEl.className = 'column';
                    columnEl.dataset.columnId = column.id;
                    columnEl.innerHTML = `<h2>${column.name}</h2><div class="task-list"></div>`;
                    boardContainer.appendChild(columnEl);
                });

                // Render tasks into columns
                const taskLists = Object.fromEntries(
                    Array.from(boardContainer.querySelectorAll('.task-list')).map(el => [el.parentElement.dataset.columnId, el])
                );

                state.currentBoard.tasks.forEach(task => {
                    const taskEl = renderTask(task);
                    if (taskLists[task.columnId]) {
                        taskLists[task.columnId].appendChild(taskEl);
                    }
                });
            }

            function renderTask(task) {
                const taskEl = document.createElement('div');
                taskEl.className = 'task';
                taskEl.dataset.taskId = task.id;

                const assigneeName = task.assigneeId ? state.users[task.assigneeId]?.name : 'Unassigned';

                taskEl.innerHTML = `
                    <h3>${task.title}</h3>
                    <p>${task.description || ''}</p>
                    <div class="assignee">Assigned to: ${assigneeName || '...'}</div>
                    <div class="task-actions">
                         <button class="ai-decompose-btn">AI Decompose</button>
                    </div>
                `;
                return taskEl;
            }

            // --- API CALLS & ACTIONS ---
            createTaskBtn.addEventListener('click', async () => {
                const title = prompt('Enter new task title:');
                if (!title) return;

                const firstColumnId = state.currentBoard.columns.find(c => c.order === 0)?.id;
                if (!firstColumnId) {
                    alert('No columns available to add task.');
                    return;
                }

                try {
                    const response = await fetch('/.netlify/functions/create-task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title,
                            boardId: state.currentBoard.id,
                            columnId: firstColumnId,
                            creatorId: state.currentUser.id,
                        }),
                    });
                    if (!response.ok) throw new Error('Failed to create task.');
                    loadBoard(state.currentBoard.id); // Reload the board
                } catch (error) {
                    console.error(error);
                    alert(error.message);
                }
            });

            boardContainer.addEventListener('click', async (e) => {
                if (e.target.classList.contains('ai-decompose-btn')) {
                    const taskEl = e.target.closest('.task');
                    const taskId = taskEl.dataset.taskId;
                    e.target.disabled = true;
                    e.target.textContent = '...decomposing';
                    try {
                        const response = await fetch('/.netlify/functions/request-ai-decomposition', {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ taskId, userId: state.currentUser.id }),
                        });
                        if (!response.ok) throw new Error('Failed to request AI decomposition.');
                        const suggestion = await response.json();
                        alert(`AI suggestion created with status: ${suggestion.status}. An admin needs to approve it.`);
                        e.target.textContent = 'Suggestion Pending';
                    } catch (error) {
                        console.error(error);
                        alert(error.message);
                        e.target.disabled = false;
                        e.target.textContent = 'AI Decompose';
                    }
                } else if (e.target.closest('.task')) {
                    const taskEl = e.target.closest('.task');
                    const taskId = taskEl.dataset.taskId;
                    alert(`Task ${taskId} clicked. Showing personal tasks would happen here.`);
                    // Placeholder for showing task details and personal tasks.
                }
            });

            analyticsBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/.netlify/functions/get-analytics?boardId=${state.currentBoard.id}&userId=${state.currentUser.id}`);
                    if (!response.ok) throw new Error('Failed to load analytics.');
                    const metrics = await response.json();

                    analyticsContent.innerHTML = `
                        <ul>
                            <li>Всего задач: <strong>${metrics.total_tasks}</strong></li>
                            <li>Пропускная способность (создано за 24ч): <strong>${metrics.throughput_last_24h}</strong></li>
                            <li>Запросов на ИИ-декомпозицию: <strong>${metrics.decomposition_requests}</strong></li>
                            <li>% "Тяжелых" задач (с ИИ): <strong>${metrics.ai_heavy_tasks_percent.toFixed(2)}%</strong></li>
                        </ul>
                    `;

                    boardScreen.classList.add('hidden');
                    analyticsScreen.classList.remove('hidden');
                } catch (error) {
                    console.error(error);
                    alert(error.message);
                }
            });

            backToBoardBtn.addEventListener('click', () => {
                analyticsScreen.classList.add('hidden');
                boardScreen.classList.remove('hidden');
            });

            // Initial load
            checkLogin();
        });
    </script>
</body>
</html>
